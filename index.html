<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Fact Factoryã€€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --blue-core: #007bff;
        --blue-light: #52b6ff;
        --purple: #8f7bff;
        --bg-dark: #050814;
        --grid-size: 12;
      }

      * {
        box-sizing: border-box;
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #071838 0%, #02040a 55%, #000 100%);
        color: #e8f1ff;
        padding: 24px;
      }

      h1 {
        font-size: 2.4rem;
        text-transform: uppercase;
        letter-spacing: 0.2rem;
        text-align: center;
        margin-bottom: 8px;
      }

      .subline {
        text-align: center;
        color: #79a8ff;
        margin-bottom: 32px;
      }

      .dashboard {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .card {
        background: rgba(9, 16, 46, 0.85);
        border: 1px solid rgba(82, 182, 255, 0.3);
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.3);
        border-radius: 16px;
        padding: 20px;
        position: relative;
        overflow: hidden;
      }

      .card::after {
        content: "";
        position: absolute;
        inset: -120% auto auto -120%;
        width: 240%;
        height: 240%;
        background: radial-gradient(circle, rgba(0, 123, 255, 0.15), transparent 60%);
        animation: pulse 8s linear infinite;
        pointer-events: none;
      }

      @keyframes pulse {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .score {
        font-size: 3rem;
        font-weight: 700;
      }

      .label {
        font-size: 0.9rem;
        letter-spacing: 0.15rem;
        color: #7cd4ff;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(82, 182, 255, 0.1);
        border: 1px solid rgba(82, 182, 255, 0.4);
        font-size: 0.85rem;
      }

      .pipeline {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 8px;
      }

      .node {
        min-width: 160px;
        background: rgba(5, 17, 48, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 16px;
        position: relative;
      }

      .node::before {
        content: "";
        position: absolute;
        left: -8px;
        top: 50%;
        width: 8px;
        height: 2px;
        background: linear-gradient(90deg, rgba(0, 123, 255, 0), rgba(0, 123, 255, 0.8));
      }

      .node:first-child::before {
        display: none;
      }

      .node-title {
        font-weight: 600;
        margin-bottom: 6px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 6px;
      }

      .status-row {
        display: flex;
        align-items: center;
        margin-top: 6px;
        font-size: 0.85rem;
      }

      .logs {
        max-height: 240px;
        overflow-y: auto;
        font-family: "JetBrains Mono", "SFMono-Regular", monospace;
        background: rgba(2, 8, 31, 0.65);
        border-radius: 12px;
        padding: 14px;
        border: 1px solid rgba(82, 182, 255, 0.2);
      }

      .log-line {
        margin-bottom: 6px;
        color: #b8d4ff;
      }

      .fact-line {
        cursor: pointer;
      }

      .fact-line:hover {
        color: #ffffff;
        text-decoration: underline;
      }

      .belt-card {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .belt-track {
        position: relative;
        height: 72px;
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(82, 182, 255, 0.4);
        background: linear-gradient(90deg, rgba(0, 123, 255, 0.2) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(0, 123, 255, 0.2) 100%);
      }

      .belt-track::before {
        content: "";
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          -45deg,
          rgba(0, 123, 255, 0.12) 0,
          rgba(0, 123, 255, 0.12) 12px,
          rgba(0, 0, 0, 0.4) 12px,
          rgba(0, 0, 0, 0.4) 24px
        );
        animation: conveyor 6s linear infinite;
      }

      @keyframes conveyor {
        from {
          transform: translateX(0);
        }
        to {
          transform: translateX(-48px);
        }
      }

      .belt-items {
        position: relative;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        height: 100%;
        z-index: 1;
      }

      .belt-item {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #ffffff;
        font-size: 0.85rem;
        gap: 6px;
      }

      .belt-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        background: rgba(82, 182, 255, 0.2);
        border: 1px solid rgba(82, 182, 255, 0.5);
      }

      .flash-overlay {
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.6), rgba(0, 123, 255, 0));
        opacity: 0;
        transition: opacity 0.4s ease-out;
        mix-blend-mode: screen;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .flash-overlay.active {
        opacity: 1;
      }

      .flash-message {
        font-size: 2.2rem;
        letter-spacing: 0.1em;
        color: #ffffff;
        text-shadow: 0 0 20px rgba(0, 123, 255, 0.9);
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .flash-overlay.active .flash-message {
        opacity: 1;
        transform: scale(1);
      }

      .controls {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      button {
        background: linear-gradient(120deg, var(--blue-core), var(--purple));
        border: none;
        border-radius: 999px;
        color: white;
        padding: 14px 28px;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(0, 123, 255, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-4px);
        box-shadow: 0 14px 30px rgba(0, 123, 255, 0.45);
      }

      .pixel-grid {
        display: grid;
        grid-template-columns: repeat(var(--grid-size), 1fr);
        gap: 4px;
        margin-top: 12px;
      }

      .pixel {
        width: 14px;
        height: 14px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 3px;
        transition: background 0.3s ease, box-shadow 0.3s ease;
      }

      .pixel.active {
        background: var(--blue-light);
        box-shadow: 0 0 8px var(--blue-light);
      }

      .pixel.gold {
        background: #ffd700;
        box-shadow: 0 0 8px #ffd700;
      }
    </style>
  </head>
  <body>
    <h1>Fact Factoryã€€</h1>
    <p class="subline">æƒ…å ±åé›†ãƒ©ã‚¤ãƒ³ã‚’å¢—ç”£ã—ã¦ç„¡é™ã‚¹ã‚³ã‚¢ã‚’å©ãå‡ºã›ï¼</p>

    <div class="dashboard">
      <div class="card">
        <div class="label">CURRENT SCORE</div>
        <div class="score" id="score">0000</div>
        <div class="pill">
          <span id="condition">STABLE</span>
        </div>
        <div class="pixel-grid" id="pixelGrid"></div>
      </div>

      <div class="card">
        <div class="label">LIVE CONTROLS</div>
        <div class="controls">
          <button id="runTick">Tick Injection</button>
          <button id="autoMode">Auto Mode</button>
          <button id="heal">Auto-Heal</button>
          <button id="tweetFact">Share #FactFactory</button>
        </div>
      </div>

      <div class="card">
        <div class="label">SOURCE PRESET</div>
        <div id="sourceList"></div>
      </div>
    </div>

    <div class="card" style="margin-top: 24px">
      <div class="label">PIPELINE STATUS</div>
      <div class="pipeline" id="pipeline"></div>
    </div>

    <div class="card belt-card" style="margin-top: 24px">
      <div class="label">DATA BELT</div>
      <p class="subline" style="margin:0;color:#9ecbff;font-size:0.85rem">
        ãƒªã‚½ãƒ¼ã‚¹ãŒãƒ™ãƒ«ãƒˆã‚³ãƒ³ãƒ™ã‚¢ãƒ¼ã§æµã‚Œã€ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦çŠ¶æ…‹ãŒå¤‰åŒ–
      </p>
      <div class="belt-track">
        <div class="belt-items" id="beltItems"></div>
      </div>
    </div>

    <div class="card" style="margin-top: 24px">
      <div class="label">LOG FEED</div>
      <div class="logs" id="logs"></div>
    </div>

    <div class="card" style="margin-top: 24px">
      <div class="label">REAL-TIME FACT STREAM</div>
      <div class="logs" id="factStream"></div>
    </div>

    <div class="flash-overlay" id="flashOverlay">
      <div class="flash-message" id="flashMessage">GOLD OUTPUT!</div>
    </div>

    <script>
      // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ãƒ•ãƒ­ãƒ³ãƒˆã®ã¿ã§Factoryã®é›°å›²æ°—ã‚’å†ç¾ã™ã‚‹
      const preset = ["Gather", "Refine", "Score", "Publish", "Learn"];
      const sources = ["æ”¿åºœçµ±è¨ˆAPI", "ç ”ç©¶ãƒ—ãƒ¬ãƒ—ãƒªãƒ³ãƒˆ", "ãƒ†ãƒƒã‚¯SNS"];
      let score = 0;
      let tick = 0;
      let failureStreak = 0;
      let autoInterval = null;
      let flashTicks = 0;
      let audioCtx = null;

      const scoreEl = document.getElementById("score");
      const conditionEl = document.getElementById("condition");
      const logsEl = document.getElementById("logs");
      const pipelineEl = document.getElementById("pipeline");
      const sourceListEl = document.getElementById("sourceList");
      const pixelGridEl = document.getElementById("pixelGrid");
      const tweetButton = document.getElementById("tweetFact");
      const factStreamEl = document.getElementById("factStream");
      const beltItemsEl = document.getElementById("beltItems");
      const flashOverlay = document.getElementById("flashOverlay");
      const flashMessage = document.getElementById("flashMessage");

      // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ãƒ”ã‚¯ã‚»ãƒ«é€²æ—ã‚’åˆæœŸåŒ–
      const TOTAL_PIXELS = 24;
      for (let i = 0; i < TOTAL_PIXELS; i++) {
        const pixel = document.createElement("div");
        pixel.className = "pixel";
        pixelGridEl.appendChild(pixel);
      }

      document.getElementById("runTick").addEventListener("click", () => {
        runTick();
      });

      document.getElementById("autoMode").addEventListener("click", () => {
        if (autoInterval) {
          clearInterval(autoInterval);
          autoInterval = null;
          addLog("AUTO", "è‡ªå‹•é‹è»¢ã‚’åœæ­¢");
        } else {
          autoInterval = setInterval(runTick, 2000);
          addLog("AUTO", "è‡ªå‹•é‹è»¢ã‚’é–‹å§‹");
        }
      });

      document.getElementById("heal").addEventListener("click", () => {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ãƒ’ãƒ¼ãƒ«ã§ã‚½ãƒ¼ã‚¹é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        sources.sort(() => Math.random() - 0.5);
        renderSources();
        addLog("HEAL", "ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å†é…ç·š");
      });

      tweetButton.addEventListener("click", () => {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: åé›†æ¸ˆã¿ã®ä¸­ã§ã‚¹ã‚³ã‚¢æœ€å¤§ã®ãƒ•ã‚¡ã‚¯ãƒˆã¨ã‚²ãƒ¼ãƒ URLã‚’å…±æœ‰
        const topFact = (factBuffer.length ? factBuffer : factPool).reduce((max, fact) =>
          fact.score > max.score ? fact : max
        );
        const tweetText = `${topFact.info} ${topFact.value} / ${topFact.source} https://kg-ninja.github.io/FactFactory/ #FactFactory`;
        const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
        window.open(tweetUrl, "_blank", "noopener");
        addLog("SHARE", `æœ€é«˜ã‚¹ã‚³ã‚¢è¨˜äº‹(${topFact.source})ã‚’ã‚·ã‚§ã‚¢`);
      });

      const factPool = [
        {
          info: "NOAAã®æµ·é¢æ°´æ¸©å¹³å¹´å·®",
          value: "+0.93â„ƒ",
          source: "NOAA",
          url: "https://www.noaa.gov/",
          score: 88,
        },
        {
          info: "FAOä¸–ç•Œé£Ÿæ–™ä¾¡æ ¼æŒ‡æ•°",
          value: "121.8",
          source: "FAO",
          url: "https://www.fao.org/worldfoodsituation/foodpricesindex",
          score: 76,
        },
        {
          info: "IEAå†ã‚¨ãƒæŠ•è³‡",
          value: "+35% YoY",
          source: "IEA",
          url: "https://www.iea.org/reports/world-energy-investment-2024",
          score: 91,
        },
        {
          info: "GitHub AIãƒˆãƒ¬ãƒ³ãƒ‰",
          value: "AutoRAG",
          source: "GitHub",
          url: "https://github.com/trending",
          score: 70,
        },
        {
          info: "IMFä¸–ç•Œæˆé•·ç‡è¦‹é€šã—",
          value: "2025å¹´3.1%",
          source: "IMF",
          url: "https://www.imf.org/en/Publications/WEO",
          score: 84,
        },
      ];
      const factBuffer = [];
      const beltSlotCount = 6;
      const beltData = Array.from({ length: beltSlotCount }, () => ({ icon: "ğŸŒ€", label: "IDLE", flash: false }));
      const flashMessages = [
        "GOLD OUTPUT!",
        "FACTORY SYNC 100%",
        "ãƒã‚¤ãƒãƒªãƒ¥ãƒ¼æƒ…å ±å‡ºè·",
        "CONDITION GREEN",
      ];

      function runTick() {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãŒç¶™ç¶šã—ã¦ã„ã‚Œã°Tickã”ã¨ã«æ®‹ã‚Šã‚’æ¸›ç®—
        if (flashTicks > 0) {
          flashTicks--;
          if (flashTicks === 0) {
            flashOverlay.classList.remove("active");
          }
        }
        tick++;
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ã‚¹ã‚³ã‚¢ã‚’ç–‘ä¼¼çš„ã«ç®—å‡º
        const tickScore = Math.round(Math.random() * 120);
        score += tickScore;
        scoreEl.textContent = score.toString().padStart(4, "0");
        updatePixels(Math.min(100, (score / 1200) * 100));
        renderPipeline(tickScore);
        addLog("TICK " + tick, `Score +${tickScore}`);
        advanceBelt(tickScore);
        streamFact();

        if (tickScore < 40) {
          failureStreak++;
          conditionEl.textContent = "CONDITION RED";
          conditionEl.style.color = "#ff7373";
          addLog("ALERT", `Condition Redç™ºç”Ÿ ${failureStreak}å›ç›®`);
          if (failureStreak === 2) {
            addLog("SUPER", "Super Modeçªå…¥ï¼ä»£æ›¿æ¡ˆã‚’ç”Ÿæˆ");
          }
          if (failureStreak === 5) {
            addLog("SAFE", "Game Overå›é¿ã®ãŸã‚Alternative Angleã¸åˆ‡æ›¿");
            failureStreak = 0;
          }
        } else {
          failureStreak = 0;
          conditionEl.textContent = "STABLE";
          conditionEl.style.color = "#7cd4ff";
        }
      }

      function renderPipeline(tickScore) {
        pipelineEl.innerHTML = "";
        preset.forEach((stage, index) => {
          const node = document.createElement("div");
          node.className = "node";
          node.innerHTML = `
            <div class="node-title">${stage}</div>
            <div class="status-row">
              <span class="status-dot" style="background:${getStageColor(index, tickScore)}"></span>
              <span>${getStatusText(index, tickScore)}</span>
            </div>
          `;
          pipelineEl.appendChild(node);
        });
      }

      function renderSources() {
        sourceListEl.innerHTML = sources
          .map((source, idx) => `<div class="pill">ã‚½ãƒ¼ã‚¹${idx + 1}: ${source}</div>`)
          .join("");
      }

      function advanceBelt(tickScore) {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦ãƒ™ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
        const icon = tickScore < 40 ? "âš " : tickScore > 90 ? "â­" : "âš™";
        const label = tickScore < 40 ? "è­¦æˆ’" : tickScore > 90 ? "é»„é‡‘ãƒ©ã‚¤ãƒ³" : "å‡¦ç†ä¸­";
        const flash = tickScore > 90;
        beltData.pop();
        beltData.unshift({ icon, label, flash });
        const tail = beltData[beltSlotCount - 1];
        if (tail.flash) {
          triggerFlash();
          tail.flash = false;
        }
        renderBelt();
      }

      function renderBelt() {
        beltItemsEl.innerHTML = beltData
          .map(
            (item) =>
              `<div class="belt-item"><span class="belt-icon">${item.icon}</span><span>${item.label}</span></div>`
          )
          .join("");
      }

      function triggerFlash() {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: å„ªç§€ãƒ‡ãƒ¼ã‚¿ãŒæœ€çµ‚ãƒãƒ¼ãƒ‰ã¸åˆ°é”ã—ãŸç¬é–“ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
        flashMessage.textContent = flashMessages[Math.floor(Math.random() * flashMessages.length)];
        flashTicks = 2;
        flashOverlay.classList.add("active");
        playChime();
      }

      function playChime() {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: Web Audioã§éˆ´ã®éŸ³ã‚’åˆæˆã—ã¦é€šçŸ¥
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        if (!audioCtx) audioCtx = new AudioContext();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const now = audioCtx.currentTime;
        osc.type = "sine";
        osc.frequency.setValueAtTime(880, now);
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.4, now + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.6);
      }

      function updatePixels(progress) {
        const activePixels = Math.round((progress / 100) * TOTAL_PIXELS);
        const pixels = pixelGridEl.querySelectorAll(".pixel");
        pixels.forEach((pixel, idx) => {
          pixel.classList.remove("active", "gold");
          if (idx < activePixels) {
            pixel.classList.add(progress >= 80 ? "gold" : "active");
          }
        });
      }

      function addLog(tag, text) {
        const line = document.createElement("div");
        line.className = "log-line";
        line.textContent = `[${tag}] ${text}`;
        logsEl.prepend(line);
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ãƒ­ã‚°ãŒå¤šã™ãã‚‹å ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
        while (logsEl.childElementCount > 30) {
          logsEl.removeChild(logsEl.lastChild);
        }
      }

      function streamFact() {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: æ–°è¦åé›†ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¯è¦–åŒ–
        const fact = factPool[Math.floor(Math.random() * factPool.length)];
        factBuffer.unshift({ ...fact, ts: new Date().toLocaleTimeString("ja-JP", { hour12: false }) });
        while (factBuffer.length > 8) {
          factBuffer.pop();
        }
        renderFactStream();
      }

      function renderFactStream() {
        factStreamEl.innerHTML = factBuffer
          .map(
            (item) =>
              `<div class="log-line fact-line" data-url="${item.url}">[${item.ts}] ${item.info}: <strong>${item.value}</strong> <span style="color:#7cd4ff">#FactFactory</span> / ${item.source}</div>`
          )
          .join("");
      }

      factStreamEl.addEventListener("click", (event) => {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…ƒã‚½ãƒ¼ã‚¹ã‚’å³æ™‚å‚ç…§
        let target = event.target;
        if (target.nodeType !== 1) target = target.parentElement;
        if (!target) return;
        const factLine = target.closest ? target.closest(".fact-line") : null;
        if (!factLine) return;
        const url = factLine.getAttribute("data-url");
        if (url) window.open(url, "_blank", "noopener");
      });

      function getStageColor(index, tickScore) {
        // æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ: ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ã®ç™ºå…‰ã‚«ãƒ©ãƒ¼ã‚’è¿”ã™
        if (tickScore < 40 && index >= 2) return "#ff7373";
        const colors = ["#52b6ff", "#7cf6ff", "#ffd700", "#9ef887", "#52b6ff"];
        return colors[index % colors.length];
      }

      function getStatusText(index, tickScore) {
        const texts = [
          "åé›†å¼·åº¦: " + (60 + index * 5) + "%",
          "ãƒã‚¤ã‚ºé™¤å»: Poisson Gate",
          `è©•ä¾¡: ${tickScore.toFixed(0)}pt`,
          "å‡ºè·ãƒ©ã‚¤ãƒ³ç¨¼åƒä¸­",
          "å­¦ç¿’ã‚¦ã‚§ã‚¤ãƒˆèª¿æ•´",
        ];
        return texts[index];
      }

      renderSources();
      renderPipeline(80);
      updatePixels(10);
      renderBelt();
      addLog("INIT", "Fact Factoryã€€ã‚’èµ·å‹•");
    </script>
  </body>
</html>
